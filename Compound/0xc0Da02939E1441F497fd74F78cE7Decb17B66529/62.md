## Split COMP rewards distribution and bug fixes

_Updated as of block [14000886](https://etherscan.io/block/14000886) at 1/13/2022, 9:18:57 PM ET_

- ID: 62
- Proposer: [0xc8A69971DAa3C3ADd85Ab0d0AF297515769ddfFC](https://etherscan.io/address/0xc8A69971DAa3C3ADd85Ab0d0AF297515769ddfFC)
- Start Block: 13285618 (9/23/2021, 9:52:46 PM ET)
- End Block: 13305328 (9/26/2021, 10:57:11 PM ET)
- Targets: [0x3d9819210A31b4961b30EF54bE2aeD79B9c9Cd3B](https://etherscan.io/address/0x3d9819210A31b4961b30EF54bE2aeD79B9c9Cd3B#code); [0x374ABb8cE19A73f2c4EFAd642bda76c797f19233](https://etherscan.io/address/0x374ABb8cE19A73f2c4EFAd642bda76c797f19233#code)

<details>
  <summary>Proposal text</summary>

> # Split COMP rewards distribution and bug fixes
> This proposal completes RFP 15: Dynamic COMP reward distribution as well as fixes a few bugs.
> 
> ## Split COMP rewards distribution
> 
> ### Problem
> 
> At the moment, the COMP rewards rate for any single market is applied at the same rate for both suppliers and borrowers. This creates undesirable market conditions such as, but not limited to, negative interest rates when borrowing various assets.
> 
> An example is the WBTC market - we want to distribute COMP rewards for suppliers, but since this distribution rate applies at the same rate for both borrowers and suppliers, we end up with WBTC being borrowed at a negative interest rate. The same applies to most non-stablecoin markets.
> 
> ### Solution
> 
> This proposal changes the Comptroller logic to have two different COMP distribution rates for each and every market - borrow-side (_compBorrowSpeeds_) rate and supply-side (_compSupplySpeeds_) rate.
> 
> The function `Comptroller._setCompSpeeds(CToken[],uint256[],uint256[])` is introduced to enable governance to set these differing rates.
> 
> Example usage: `Comptroller._setCompSpeeds([cUSDC],[0],[1e18])` - will set the COMP rewards for supplying USDC at 0 COMP per block, and for borrowing at 1 COMP per block.
> 
> ## COMP rewards distribution bug fixes
> 
> This proposal fixes the following bugs:
> - Market state indices were not being set when COMP rewards are added to already active markets. [[Bug 1](https://www.comp.xyz/t/comptroller-compspeed-bug/2111)]
> - COMP rewards were distributed for periods preceding when the distribution rate is set. [[Bug 2](https://www.comp.xyz/t/comptroller-compspeed-bug/2111)]
> - Borrowers were having to poke their borrow to accrue rewards if they borrowed before rewards rates were set. [[Bug 3](https://github.com/compound-finance/compound-protocol/pull/144/commits/f6d717bb78bef0c9851ad672f7b9aa1d90b0f00a)]
> 
> ## Technical changes
> - `Comptroller#compSpeeds` storage variable is no longer being used and has been effectively deleted. It's replaced by `Comptroller#compBorrowSpeeds` and `Comptroller#compSupplySpeeds`. This proposal copies the current rates into the new storage variables.
> - `Comptroller#_setCompSpeed(CToken,uint256)` function has been removed and replaced by `Comptroller#_setCompSpeeds(CToken[],uint256[],uint256[])`. This new function allows COMP rewards rates for multiple markets to be set with a single call.
> - An upgrade hook initializes all non-initialized market state indices (initial index is 1e36).
> - When new markets are added, their state indices are now properly initialized (used to use lazy initialization which caused many problems).
> 
> ## Other notable changes
> - Depositing now uses slightly less gas after a user's initial deposit.
> - Calling `Comptroller#claimComp` unfortunately uses a lot more gas to account for uninitialized borrow state indices. It's recommended to specify which markets (and which sides) to claim COMP in rather than claiming across all markets simultaneously.
> - Flywheel tests have been updated and expanded upon to prevent the bugs fixed in this proposal from occurring again.
> - These changes have been live on the Ropsten testnet for nearly a month and everything is working as expected.
> 
> ## Credits
> - Arr00: initial code supporting split COMP rewards; flywheel test re-writes
> - Getty: bugs 1 and 2 diagnosis help and disclosure
> - Elee: bugs 1 and 2 diagnosis help, fixing, and disclosure
> - Coburn: bug 3 identification; test case
> - Compound Labs (especially Jared): reviewing, guidance, general help, and coordination
> - TylerEther (me): full implementation of split COMP rewards; testing infrastructure changes; bugs 1 and 2 identification, diagnosis, fixing, and disclosure; bug 3 fix; overall coordination; general testing; addition of many new test cases; proposal
> 
> ## References
> - [GitHub PR](https://github.com/compound-finance/compound-protocol/pull/144/)
> - [Proposal simulation](https://github.com/TylerEther/compound-protocol/blob/f73b29373eb65cedf24896d7be46eed38435fc91/spec/sim/0011-split-comp-rewards/hypothetical_mainnet_upgrade.scen)
> - [Comptroller compSpeed bug disclosure](https://www.comp.xyz/t/comptroller-compspeed-bug/2111)
> - [Forums discussion](https://www.comp.xyz/t/rfp-16-dynamic-comp-reward-distribution/2016/11)
> - [Etherscan - contract](https://etherscan.io/address/0x374abb8ce19a73f2c4efad642bda76c797f19233#code)
</details>

### Checks
#### Reports all state changes from the proposal âœ… Passed
  




Info:
- State changes:
    - Unitroller at `0x3d9819210A31b4961b30EF54bE2aeD79B9c9Cd3B`
        - `comptrollerImplementation` changed from `0x75442ac771a7243433e033f3f8eab2631e22938f` to `0x374abb8ce19a73f2c4efad642bda76c797f19233`
        - Slot `0x352c3ab674d581f5f505a575bd0a1e303a5a163037d72e1d2f09bd387d62d451` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"`
        - Slot `0xc151e8673549c97c829b45121809121bc1016d5242a4f7392e5d5ae92f29c98b` changed from `"0x00cb392400000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0xa5709065d91348a40bbb19b8513250f00d71a9b92744ff454d3e7bad67389cee` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"`
        - Slot `0x5790eb5fc1168499a829bc5b448df66c73a1e3507801a8e5e74d39cdc19274d1` changed from `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"` to `"0x0000000000000000000000000000000000000000000000000000000000000000"`
        - Slot `0xf02f790eed65c1a321a1a099b0126c07476bfa74f96977eced2286cb0e5d702e` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"`
        - Slot `0xfba82868b39beedc8aaf9fe4c9ecced4b9a9b03d24d288002bdcd29ac6b5aaff` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x000000000000000000000000000000000000000000000000002631116b55e000"`
        - Slot `0x8f95aae60010aabae421e08d4774128673af554d67d7424a60f67a169630435c` changed from `"0x000000000000000000000000000000000000000000000000002631116b55e000"` to `"0x0000000000000000000000000000000000000000000000000000000000000000"`
        - Slot `0x304f8f4ae5e7b77bfebeaf735ed40d7718e4fe2ab06947ddfb89796ec7e667fe` changed from `"0x00cb3e7700000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0x22b3ea9ab5ac2063fdea9677451f46134737be23781c79177b13ab434211aa7d` changed from `"0x00cb451c00000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0xb2b965f5d65045cb3ba033f26b710e9a9b8b4ab18ed74076fc26c66fcb3c4192` changed from `"0x00cb392400000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0x62da13d90019ef3f6473d8b81f53ec8623cc75f4f8090f464eb38120b51885d6` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x000000000000000000000000000000000000000000000000002631116b55e000"`
        - Slot `0x603c9d78bf0b37df48605b777a5a507393536504e173045be9459968a1750c84` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"`
        - Slot `0xb31112cdaa61f3ac68012f946a5e80a9f2c8b894d854f07cc426d851e0aecbd1` changed from `"0x0000000000000000000000000000000000000000000000000011c37937e08000"` to `"0x0000000000000000000000000000000000000000000000000000000000000000"`
        - Slot `0x94822b701f4bff86914fc204a326279303456683207ae1f6c4b1ad348de33bee` changed from `"0x000000000000000000000000000000000000000000000000002631116b55e000"` to `"0x0000000000000000000000000000000000000000000000000000000000000000"`
        - Slot `0xd97e1b46a5874c4f66d5d09392f031647728fa42cbe5c4e3a115c3c849d55663` changed from `"0x00cb392400000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0xeaf505fc70f4821f07ab2720fd3e1966f68830f22aef4a53c6962a5eee88c90a` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000ee08251ff38000"`
        - Slot `0x0d75adcef32075d851d1fcfe691721513f601ef52807cc8605267f0aeb686599` changed from `"0x00000000000000000000000000000000000000000000000000ee08251ff38000"` to `"0x0000000000000000000000000000000000000000000000000000000000000000"`
        - Slot `0xdf5f6f687b13156bd2645564ba7544e82c7033fbedde071bdb9283127eecb00b` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"`
        - Slot `0x25674323683cf61f0c5448226c41788ac99e5fd367d229b90d918341938d29f4` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x000000000000000000000000000000000000000000000000002631116b55e000"`
        - Slot `0x1a9ee3897ecf9051312025666d8cce368d550f03d09b939a56516d8f59339cb2` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"`
        - Slot `0x5f6650a6be0922b865873b285ce1dfbe0c4aa155cc03bbb9a3b04019b8c104d3` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000ee08251ff38000"`
        - Slot `0x09066dc837f370cbbb3d27c02285ea0cf53b6ff6974cd52c8b1a6d5f08724b90` changed from `"0x00cb3fd000000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0x5053162b24a5ef457fc45e63445a9421143861eaca523ee9a46b05327f0a9c05` changed from `"0x00cb392400000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0xf8acb6d8daa3290b2b335df9a4c13dab7b42d9cf8dcedc3090dc473ac4987c42` changed from `"0x0000000000000000000000000000000000000000000000000022489fb6152000"` to `"0x0000000000000000000000000000000000000000000000000000000000000000"`
        - Slot `0xf00044c3aa089c6638c1ae04ca3899b0abb4df72a8d8edd086ebc24dee531ff2` changed from `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"` to `"0x0000000000000000000000000000000000000000000000000000000000000000"`
        - Slot `0x523a392ccecad24e73a9c8c3d6d8d055868dbcc156faa7022b6665409ba2778b` changed from `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"` to `"0x0000000000000000000000000000000000000000000000000000000000000000"`
        - Slot `0x566eecf9cdf3db792d3aafb022b13c790bc719a16bcbd464b6ebeb12eb355a37` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"`
        - Slot `0x7011a3581cf6ca0f96bed67b32dd93a8d4705a85a1af0a4399dedd5661ac8a1a` changed from `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"` to `"0x0000000000000000000000000000000000000000000000000000000000000000"`
        - Slot `0xa451a634c72d1de4ad9a172974ab06aabf61ae18ecd2afb8fa4afbcffc76c216` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000ee08251ff38000"`
        - Slot `0x7699274f9608b2e293bfea4bebe10b5174c1a84f1f540939f1e17cceb033c2bb` changed from `"0x00000000000000000000000000000000000000000000000000ee08251ff38000"` to `"0x0000000000000000000000000000000000000000000000000000000000000000"`
        - Slot `0x6c627db00b3ec0f04ea2ed17d2c73909bd167cfb6ad5af5b2c216bc8ea6da0d9` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000ee08251ff38000"`
        - Slot `0x061b603c6e263c8df524a24b81cfc4818325b334d8a5b91cbc51bdfdcb002558` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x0000000000000000000000000000000000000000000000000011c37937e08000"`
        - Slot `0x2c33859b24bedfe28f622b77fbfe1d7c2ed71a05f4852a901de0bbcd357a2087` changed from `"0x00cb495100000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0xd965a17ea477373995dcd996d1daee0e4172c9960c97366e5be68768bbcb2127` changed from `"0x00cb497b00000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0x80340aeac0268390b838047b6ddb5926b9e1070d45e2bdd242e15eabe8142d4a` changed from `"0x00cb425000000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0x00796f43d5b6c2fff539a2d9967478960dec16e2c3e343bccc03cae8c34e424e` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x0000000000000000000000000000000000000000000000000022489fb6152000"`
        - Slot `0x3e7fce1f7a2221f8f23144eb57a7dcb04cf2a60ab4ca6d2980bfc4e37dde9788` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x0000000000000000000000000000000000000000000000000022489fb6152000"`
        - Slot `0x5348bfb4e7b56db6480904f3ff5d2c35264b28d2c85f2a0ccea6bd40478f246a` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x000000000000000000000000000000000000000000000000002631116b55e000"`
        - Slot `0x85be4e7ba61cd3477f5fb7799ada65e1b6496dc9ef0158c8ece4b1e31883fb06` changed from `"0x00cb42c400000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`
        - Slot `0x8d618f29c75cbde5f91445e8d44e099441c172a4e6a8cb64ff0b0254f2a5b98e` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x00000000000000000000000000000000000000000000000000053222d0fbe800"`
        - Slot `0xed1eeabbae0b70e8e0c7bb3ab46409562822f82abfb854a060fe96c185df3e83` changed from `"0x0000000000000000000000000000000000000000000000000000000000000000"` to `"0x0000000000000000000000000000000000000000000000000011c37937e08000"`
        - Slot `0x0801f638d9c0259d83e51e38981defc3450ee7fba15874466a945d5b76dd2e8d` changed from `"0x00cb392400000000000000000000000000000000000000000000000000000000"` to `"0x00cb4a2e00000000000000000000000000c097ce7bc90715b34b9f1000000000"`

#### Reports all events emitted from the proposal âœ… Passed
  




Info:
- Events Emitted:
    - Unitroller at `0x3d9819210A31b4961b30EF54bE2aeD79B9c9Cd3B`
        - `NewPendingImplementation(oldPendingImplementation: 0x0000000000000000000000000000000000000000, newPendingImplementation: 0x374abb8ce19a73f2c4efad642bda76c797f19233)`
        - `NewImplementation(oldImplementation: 0x75442ac771a7243433e033f3f8eab2631e22938f, newImplementation: 0x374abb8ce19a73f2c4efad642bda76c797f19233)`
        - `NewPendingImplementation(oldPendingImplementation: 0x374abb8ce19a73f2c4efad642bda76c797f19233, newPendingImplementation: 0x0000000000000000000000000000000000000000)`

#### Check all targets are verified on Etherscan âœ… Passed
  




Info:
- Targets:
    - 0x3d9819210A31b4961b30EF54bE2aeD79B9c9Cd3B: Contract (verified)
    - 0x374ABb8cE19A73f2c4EFAd642bda76c797f19233: Contract (verified)

#### Check all touched contracts are verified on Etherscan âœ… Passed
  




Info:
- Touched address:
    - 0xc8A69971DAa3C3ADd85Ab0d0AF297515769ddfFC: EOA (verification not applicable)
    - 0xc0Da02939E1441F497fd74F78cE7Decb17B66529: Contract (verified)
    - 0x563A63d650a5D259abAE9248dddC6867813d3f87: Contract (verified)
    - 0x6d903f6003cca6255D85CcA4D3B5E5146dC33925: Contract (verified)
    - 0x3d9819210A31b4961b30EF54bE2aeD79B9c9Cd3B: Contract (verified)
    - 0x374ABb8cE19A73f2c4EFAd642bda76c797f19233: Contract (verified)
